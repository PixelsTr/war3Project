# Warcraft III 自定义地图开发 Wiki（类《时空之痕》风格 / 基于 1.27 + Lua）

> 本文档记录整个地图开发过程，包含系统设计、版本迭代、核心模块说明，目标为打造一款战斗爽感强、系统完整的 RPG 自定义地图。

---

## 📌 开发版本迭代记录

### v0.1 初始原型阶段
- ✅ 确定技术路线（1.27 原生引擎 + Lua 脚本 + Gulp 打包）
- ✅ 技能系统原型：技能注册、触发器监听、冷却机制
- ✅ UI替代方案：原生UI遮罩策略、Dialog模拟交互
- 🔄 装备掉落机制：单位死亡 → 掉落 → 分发到玩家房间

### v0.2 技能 & UI 深化阶段（计划中）
- ⬜ 技能系统补全：等级成长、效果数据动态渲染
- ⬜ UI 模块封装：技能栏、装备栏、状态显示统一模块化
- ⬜ 增加技能描述格式化（支持ALT悬浮显示详细伤害）

### v0.3 装备系统拓展阶段（计划中）
- ⬜ 装备穿戴系统（绑定、栏位、属性加成）
- ⬜ 属性系统基础框架（力量/敏捷/智力/攻击等）
- ⬜ UI同步展示穿戴效果（攻击力、护甲变化）
- ⬜ Demo测试准备：构建第一个装备穿戴 + 加属性流程，附带注释完整的脚本供测试

...

---

## 🧱 系统结构总览

### 1. 技能系统
- 技能注册、监听
- 技能冷却与释放
- 技能动态描述渲染
- 技能ID命名规范：推荐使用语义化四字符，如 `P1F1`（玩家技能）、`MFD1`（怪物火焰犬技能）、`SFX1`（特殊机制），避免 `A001` 逐步失控的问题
- 技能池系统（可拓展）：用于构建“模式化怪物能力”或“随机技能搭配”，支持：
  - 基础定义：`SkillPools = { elite_pool = {"PAS_CRIT", "PAS_FIRE"}, chaos_pool = {"SFX_BLINK", "SFX_VAMP"} }`
  - 随机抽取：根据怪物类型或模式，`RandomPickFromPool("chaos_pool", count)` 挂载技能组
  - 使用场景：特殊模式怪物附加词缀、随机地图挑战、自走棋式强化、BOSS组合技能

### 2. 装备系统
- 掉落逻辑（怪物死亡）
  - 使用 `EVENT_PLAYER_UNIT_DEATH` 注册单位死亡事件
  - 通过 `GetDyingUnit()` 获取怪物坐标位置
  - 调用 `CreateItem(itemId, x, y)` 在怪物死亡位置掉落装备
  - 可使用 `GetKillingUnit()` 决定掉落归属或掉落房间
- 掉落分发（怪物原地/玩家房间）
  - 若需掉落到“专属房间”，可维护 `PlayerDropRoom[player] = { x, y }`
  - 用于防止装备被他人拾取，实现多人分配逻辑
- 装备栏模拟与穿戴逻辑
- 🔸 自定义装备属性由 `item_data`（Lua表）定义，相当于装备数据库。
- 🔸 WE 仅用于定义物品原型（图标、ID、描述外壳），不能定义逻辑属性。
- 🔸 高自由度属性（如召唤物、火伤、魔伤、吸血等）需完全由 Lua 实现并绑定至装备 ID。

### 3. 自定义 UI 系统
- 遮罩原生界面（固定模型 + 摄像机调整）
- Dialog 技能栏、状态栏
- 背包与装备交互窗口

### 4. 伤害与抗性系统（自定义战斗逻辑）
- 所有伤害处理由 Lua 控制（不直接使用 `UnitDamageTarget`）
- 支持：
  - 魔法抗性（magicResist）
  - 物理抗性（physicalResist）
  - 暴击、穿透、真实伤害机制
  - 免疫类标签（如：沉默免疫、控制免疫）
- 示例结构：
```lua
UnitStats[unit] = {
  atk = 100,
  magicResist = 0.25,
  critRate = 0.15,
  tags = {"CHAOS", "NO_STUN"}
}
```
- 伤害处理流程需手动识别单位状态与属性并结算（模拟护甲类型、减免等）

### 5. 单位定义机制
- 所有单位只作为“容器”定义在编辑器中（WE）：
  - 单位 ID（如：`u001`）
  - 模型、动作、默认能力（可为空）
- Lua 中动态挂载：
  - 名称、等级、血量、攻击
  - 技能列表（skillSet）
  - 属性系统挂载（见 UnitStats）

### 6. 属性系统（计划中）
- 单位属性（力量、敏捷、智力、攻速、暴击、吸血等）
- 可挂载至装备/技能/状态效果
- 支持动态调整与 UI 同步展示

---

## 🧠 控制权分层说明

在 Warcraft III 1.27 中，Lua 所接管的职责仅限于“逻辑层”，具体控制权划分如下：

### ✅ 你可以控制的：
- 单位属性变更（力量、攻击、护甲等）
- 技能释放流程（冷却、伤害判定、控制效果）
- 玩家输入处理（键盘、鼠标点击、对话框按钮）
- 自定义UI逻辑（Dialog、TextTag、Multiboard）
- 游戏流程逻辑（胜负条件、事件分发、剧情推进）

### ❌ 你无法控制的：
- 引擎渲染与画面表现（模型播放、动作细节）
- 网络同步机制（战网/局域网帧同步）
- 地图地形与碰撞规则（由地图本身定义）
- 原生系统UI框架（如技能栏、物品栏的结构）

> ✅ Lua 是“游戏大脑”，控制系统行为；但 Warcraft 引擎仍掌握底层资源与渲染。

---

> 📌 所有 DEMO 脚本将带有完整中文注释，方便第一阶段测试与调试。

> 文档持续更新中...
